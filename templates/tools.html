{% extends 'base.html' %}

{% block title %}Products - AgriConnect{% endblock %}

{% block content %}
<h2 style="text-align:center; margin-top:1rem;">Tools</h2>
<!-- üîç Modern Product Search Bar -->
<div class="search-container">
  <form id="searchForm" method="get" action="{{ url_for('products') }}" class="search-form">
    <div class="search-bar">
      <span class="search-icon">üîç</span>
      <input
        type="text"
        id="searchInput"
        name="q"
        value="{{ query }}"
        placeholder="Search products..."
        autocomplete="off"
      />
      <div><button type="submit" class="search-btn">Search üîç</button></div>
    </div>
    <!-- üîΩ Suggestion Dropdown -->
    <div id="suggestions" class="suggestions"></div>
  </form>
</div>

<div class="products-container">
  {% for product in products %}
    <div class="product-card">
      {% if product.image %}
        <img src="{{ url_for('static', filename=product.image) }}" alt="{{ product.name }}">
      {% else %}
        <img src="{{ url_for('static', filename='images/placeholder.png') }}" alt="{{ product.name }}">
      {% endif %}
      <h3>{{ product.name }}</h3>
      <p class="product-price">‚Çπ{{ product.price }}</p>
      <p>{{ product.description }}</p>
      <div class="product-actions">
        <a class="btn" href="{{ url_for('add_to_cart', product_id=product._id) }}">Add to Cart</a>
        <a class="btn wishlist-btn" href="{{ url_for('add_to_wishlist', product_id=product._id) }}">Wishlist</a>
      </div>
    </div>
  {% endfor %}
</div>
<!-- üß† Auto-suggest -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("searchInput");
  const suggestions = document.getElementById("suggestions");

  input.addEventListener("input", async () => {
    const q = input.value.trim();
    if (q.length < 2) {
      suggestions.style.display = "none";
      return;
    }

    const res = await fetch(`/search_suggestions?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    if (data.length > 0) {
      suggestions.innerHTML = data
        .map(p => `<div class="suggest-item" onclick="selectSuggestion('${p.name}')">${p.name}</div>`)
        .join("");
      suggestions.style.display = "block";
    } else {
      suggestions.style.display = "none";
    }
  });

  document.addEventListener("click", e => {
    if (!e.target.closest(".search-container")) suggestions.style.display = "none";
  });
});

function selectSuggestion(name) {
  document.getElementById("searchInput").value = name;
  document.getElementById("searchForm").submit();
}
</script>
{% endblock %}
