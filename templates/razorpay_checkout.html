{% extends 'base.html' %}
{% block title %}Payment - AgriConnect{% endblock %}

{% block content %}
<div style="max-width: 700px; margin: 2rem auto; text-align: center;">
  <h1 style="color: var(--secondary-green);">💳 Secure Payment</h1>
  <p style="font-size: 1.1rem;">Complete your payment securely with Razorpay</p>

  <!--  Order Summary -->
  <div class="product-card" style="margin-top: 1.5rem; background: #f0fdf4; border: 2px solid var(--primary-green); padding: 1rem;">
    <h3>Order Total: ₹{{ grandtotal }}</h3>
    <p><strong>Customer:</strong> {{ user_email }}</p>
    <p><strong>Order ID:</strong> {{ razorpay_order.id }}</p>
  </div>

  <!--  Shipping Preview -->
  {% if order and order.shipping_info %}
  <div class="product-card" style="margin-top: 1rem; text-align: left; background: #fff; border: 1px solid #dcdcdc; border-radius: 10px; padding: 1rem;">
    <h3>📦 Shipping To:</h3>
    <p><strong>{{ order.shipping_info.full_name }}</strong></p>
    <p>{{ order.shipping_info.address }}, {{ order.shipping_info.city }}</p>
    <p>{{ order.shipping_info.state }} - {{ order.shipping_info.pincode }}</p>
    <p>📞 {{ order.shipping_info.phone }}</p>
  </div>
  {% endif %}

  <!--  Razorpay Button -->
  <button id="rzp-button1" class="btn" style="margin-top: 1.5rem;">Pay Now ₹{{ grandtotal }}</button>

  <!--  Success Message (hidden initially) -->
  <div id="success-message" style="display:none; margin-top:2rem;">
    <img src="{{ url_for('static', filename='images/success.gif') }}" alt="Success" width="150" height="150">
    <h2 style="color:#2ecc71;">Payment Successful!</h2>
    <p>Your order has been placed successfully. 🎉</p>
    <a href="{{ url_for('my_orders') }}" class="btn">Go to My Orders</a>
  </div>
</div>

<!-- Razorpay Integration -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
const options = {
  "key": "{{ key_id }}",
  "amount": "{{ razorpay_order.amount }}",
  "currency": "INR",
  "name": "Agri-Connect",
  "description": "Secure Payment Gateway",
  "image": "{{ url_for('static', filename='images/logo.png') }}",
  "order_id": "{{ razorpay_order.id }}",
  "handler": function (response) {
    fetch("/payment-success", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        razorpay_payment_id: response.razorpay_payment_id,
        razorpay_order_id: response.razorpay_order_id,
        razorpay_signature: response.razorpay_signature
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        document.getElementById("rzp-button1").style.display = "none";
        document.getElementById("success-message").style.display = "block";
      } else {
        alert("❌ Payment verification failed. Please try again.");
      }
    });
  },
  "theme": {"color": "#00a65a"}
};

document.getElementById('rzp-button1').onclick = function(e) {
  const rzp1 = new Razorpay(options);
  rzp1.open();
  e.preventDefault();
}
</script>
{% endblock %}
